# =============================================================================
# Nebula Application Services - Production Configuration
# =============================================================================
# Only the Gateway Service is exposed externally.
# All other services communicate internally via the Docker network.
#
# Usage:
#   docker compose -f docker-compose.yml -f docker-compose.services.yml up -d --build
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # Platform Core (Eureka + Config Server) - INTERNAL ONLY
  # Must start first as other services depend on it
  # ---------------------------------------------------------------------------
  platform-core:
    build:
      context: ..
      dockerfile: services/platform-core/Dockerfile
    container_name: nebula-platform-core
    env_file:
      - .env
    environment:
      SPRING_PROFILES_ACTIVE: docker,native
    expose:
      - "8761"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8761/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    restart: unless-stopped
    networks:
      - nebula-network

  # ---------------------------------------------------------------------------
  # Gateway Service - EXTERNALLY EXPOSED (Entry point for all API requests)
  # ---------------------------------------------------------------------------
  gateway-service:
    build:
      context: ..
      dockerfile: services/gateway-service/Dockerfile
    container_name: nebula-gateway-service
    env_file:
      - .env
    environment:
      SPRING_PROFILES_ACTIVE: docker
      EUREKA_CLIENT_ENABLED: "false"
      SPRING_CLOUD_CONFIG_ENABLED: "false"
      # Service URLs for routing
      VEHICLE_SERVICE_URL: http://vehicle-service:8081
      WORLD_VIEW_SERVICE_URL: http://world-view:8082
      USER_SERVICE_URL: http://user-service:8083
      MERCHANDISE_SERVICE_URL: http://merchandise-service:8084
    ports:
      - "8080:8080"
    depends_on:
      platform-core:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    restart: unless-stopped
    networks:
      - nebula-network

  # ---------------------------------------------------------------------------
  # User Service - INTERNAL ONLY
  # ---------------------------------------------------------------------------
  user-service:
    build:
      context: ..
      dockerfile: services/user-service/Dockerfile
    container_name: nebula-user-service
    env_file:
      - .env
    environment:
      SPRING_PROFILES_ACTIVE: docker,shared-database
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      EUREKA_CLIENT_ENABLED: "false"
      SPRING_CLOUD_CONFIG_ENABLED: "false"
    expose:
      - "8083"
    depends_on:
      postgres:
        condition: service_healthy
      platform-core:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8083/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    restart: unless-stopped
    networks:
      - nebula-network

  # ---------------------------------------------------------------------------
  # Vehicle Service - INTERNAL ONLY
  # ---------------------------------------------------------------------------
  vehicle-service:
    build:
      context: ..
      dockerfile: services/vehicle-service/Dockerfile
    container_name: nebula-vehicle-service
    env_file:
      - .env
    environment:
      SPRING_PROFILES_ACTIVE: docker,shared-database
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      EUREKA_CLIENT_ENABLED: "false"
      SPRING_CLOUD_CONFIG_ENABLED: "false"
    expose:
      - "8081"
    depends_on:
      postgres:
        condition: service_healthy
      platform-core:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8081/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    restart: unless-stopped
    networks:
      - nebula-network

  # ---------------------------------------------------------------------------
  # World View Service - INTERNAL ONLY
  # ---------------------------------------------------------------------------
  world-view:
    build:
      context: ..
      dockerfile: services/world-view/Dockerfile
    container_name: nebula-world-view
    env_file:
      - .env
    environment:
      SPRING_PROFILES_ACTIVE: docker,shared-database,shared-rabbitmq
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      MQTT_HOST: rabbitmq
      MQTT_PORT: 1883
      EUREKA_CLIENT_ENABLED: "false"
      SPRING_CLOUD_CONFIG_ENABLED: "false"
    expose:
      - "8082"
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      platform-core:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8082/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    restart: unless-stopped
    networks:
      - nebula-network

  # ---------------------------------------------------------------------------
  # Merchandise Service - INTERNAL ONLY
  # ---------------------------------------------------------------------------
  merchandise-service:
    build:
      context: ..
      dockerfile: services/merchandise-service/Dockerfile
    container_name: nebula-merchandise-service
    env_file:
      - .env
    environment:
      SPRING_PROFILES_ACTIVE: docker,shared-database
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      EUREKA_CLIENT_ENABLED: "false"
      SPRING_CLOUD_CONFIG_ENABLED: "false"
    expose:
      - "8084"
    depends_on:
      postgres:
        condition: service_healthy
      platform-core:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8084/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    restart: unless-stopped
    networks:
      - nebula-network
