# =============================================================================
# Nebula Application Services
# =============================================================================
# This compose file runs the application services (merchandise, vehicle, world-view)
#
# Usage:
#   Build and run all (infrastructure + services):
#      docker compose -f docker-compose.yml -f docker-compose.services.yml up -d --build
#
#   Or build services only (requires infrastructure already running):
#      docker compose -f docker-compose.yml -f docker-compose.services.yml build
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # Vehicle Service
  # Cars Overview and Configurator API
  # ---------------------------------------------------------------------------
  vehicle-service:
    build:
      context: ..
      dockerfile: services/vehicle-service/Dockerfile
    container_name: nebula-vehicle-service
    env_file:
      - .env
    environment:
      SPRING_PROFILES_ACTIVE: docker,shared-database
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      EUREKA_CLIENT_ENABLED: "false"
      SPRING_CLOUD_CONFIG_ENABLED: "false"
    ports:
      - "8081:8081"
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8081/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    restart: unless-stopped
    networks:
      - nebula-network

  # ---------------------------------------------------------------------------
  # World View Service
  # Journey Simulation and Route Management API
  # ---------------------------------------------------------------------------
  world-view:
    build:
      context: ..
      dockerfile: services/world-view/Dockerfile
    container_name: nebula-world-view
    env_file:
      - .env
    environment:
      SPRING_PROFILES_ACTIVE: docker,shared-database,shared-rabbitmq
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      MQTT_HOST: rabbitmq
      MQTT_PORT: 1883
      EUREKA_CLIENT_ENABLED: "false"
      SPRING_CLOUD_CONFIG_ENABLED: "false"
    ports:
      - "8082:8082"
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8082/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    restart: unless-stopped
    networks:
      - nebula-network

  # ---------------------------------------------------------------------------
  # Merchandise Service
  # Product Catalog and Shopping Cart API
  # ---------------------------------------------------------------------------
  merchandise-service:
    build:
      context: ..
      dockerfile: services/merchandise-service/Dockerfile
    container_name: nebula-merchandise-service
    env_file:
      - .env
    environment:
      SPRING_PROFILES_ACTIVE: docker,shared-database
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      EUREKA_CLIENT_ENABLED: "false"
      SPRING_CLOUD_CONFIG_ENABLED: "false"
    ports:
      - "8084:8084"
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8084/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    restart: unless-stopped
    networks:
      - nebula-network
