name: CI

on:
  pull_request:
    branches:
      - main
    types:
      - opened
      - synchronize
      - reopened
      - ready_for_review
      - edited
  pull_request_review:
    types:
      - submitted
      - dismissed
      - edited

permissions:
  contents: read
  pull-requests: read

concurrency:
  group: ci-${{ github.event.pull_request.number || github.run_id }}
  cancel-in-progress: true

jobs:
  review-gates:
    name: Review gates
    runs-on: ubuntu-latest
    steps:
      - name: Validate approvals and resolved threads
        uses: actions/github-script@v7
        env:
          COPILOT_REVIEWERS: github-copilot[bot],copilot[bot]
        with:
          script: |
            const core = require("@actions/core");
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const pull_number = context.payload.pull_request.number;

            const reviews = await github.paginate(github.rest.pulls.listReviews, {
              owner,
              repo,
              pull_number,
              per_page: 100,
            });

            const latestStateByUser = new Map();
            for (const review of reviews) {
              if (!review.user || !review.user.login) continue;
              latestStateByUser.set(review.user.login, review.state);
            }

            const author = context.payload.pull_request.user.login;
            const copilotReviewers = (process.env.COPILOT_REVIEWERS || "")
              .split(",")
              .map((value) => value.trim())
              .filter(Boolean);
            const isBot = (login) => login.endsWith("[bot]");

            const hasCopilotApproval = copilotReviewers.some(
              (login) => latestStateByUser.get(login) === "APPROVED"
            );
            const hasHumanApproval = Array.from(latestStateByUser.entries()).some(
              ([login, state]) =>
                state === "APPROVED" && login !== author && !isBot(login)
            );
            const hasBlockingReview = Array.from(latestStateByUser.values()).some(
              (state) => state === "CHANGES_REQUESTED"
            );

            let unresolvedThreads = 0;
            let cursor = null;
            let hasNextPage = true;

            while (hasNextPage) {
              const result = await github.graphql(
                `
                  query($owner: String!, $repo: String!, $number: Int!, $cursor: String) {
                    repository(owner: $owner, name: $repo) {
                      pullRequest(number: $number) {
                        reviewThreads(first: 100, after: $cursor) {
                          nodes {
                            isResolved
                          }
                          pageInfo {
                            hasNextPage
                            endCursor
                          }
                        }
                      }
                    }
                  }
                `,
                { owner, repo, number: pull_number, cursor }
              );

              const threads = result.repository.pullRequest.reviewThreads;
              for (const thread of threads.nodes) {
                if (!thread.isResolved) unresolvedThreads += 1;
              }

              hasNextPage = threads.pageInfo.hasNextPage;
              cursor = threads.pageInfo.endCursor;
            }

            const errors = [];

            if (!hasCopilotApproval) {
              errors.push(
                "Missing Copilot approval. Update COPILOT_REVIEWERS if your bot login differs."
              );
            }
            if (!hasHumanApproval) {
              errors.push("Missing human approval (non-bot, non-author).");
            }
            if (hasBlockingReview) {
              errors.push("A review has requested changes.");
            }
            if (unresolvedThreads > 0) {
              errors.push(`Unresolved review threads: ${unresolvedThreads}.`);
            }

            if (errors.length > 0) {
              core.setFailed(errors.join(" "));
            }

  build-test:
    name: Build and test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
          cache: maven
      - name: Build and test
        run: ./mvnw -B -ntp clean verify