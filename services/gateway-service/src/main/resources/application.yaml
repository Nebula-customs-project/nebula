spring:
  application:
    name: gateway-service
  config:
    import: optional:configserver:http://localhost:8761
  profiles:
    active: ${SPRING_PROFILES_ACTIVE:dev}
  main:
    web-application-type: reactive
  cloud:
    config:
      enabled: false
    gateway:
      discovery:
        locator:
          enabled: false
      routes:
        # User Service Routes
        - id: user-service
          uri: lb://user-service
          predicates:
            - Path=/api/users/**

        # World-View Service Routes
        - id: world-view-routes
          uri: lb://world-view
          predicates:
            - Path=/api/v1/routes/**

        - id: world-view-journeys
          uri: lb://world-view
          predicates:
            - Path=/api/v1/journeys/**

        # Vehicle Service Routes
        - id: vehicle-service-vehicles
          uri: lb://vehicle-service
          predicates:
            - Path=/api/v1/vehicles/**

        # Merchandise Service Routes
        - id: merchandise-service-products
          uri: lb://merchandise-service
          predicates:
            - Path=/api/v1/merchandise/**

        - id: merchandise-service-cart
          uri: lb://merchandise-service
          predicates:
            - Path=/api/v1/cart/**

        # User Vehicle Service Routes
        - id: user-vehicle-service
          uri: lb://user-vehicle-service
          predicates:
            - Path=/api/v1/user-vehicle/**

        # User Vehicle Service WebSocket Route (Vehicle Telemetry)
        - id: user-vehicle-websocket
          uri: lb:ws://user-vehicle-service
          predicates:
            - Path=/ws/vehicle-telemetry

      globalcors:
        corsConfigurations:
          "[/**]":
            allowedOrigins: "http://localhost:3000"
            allowedMethods:
              - GET
              - POST
              - PUT
              - DELETE
              - OPTIONS
            allowedHeaders: "*"
            allowCredentials: true

server:
  port: 8080

eureka:
  client:
    service-url:
      defaultZone: http://localhost:8761/eureka/
    register-with-eureka: true
    fetch-registry: true
    enabled: true
    healthcheck:
      enabled: true
    # Retry configuration for better resilience
    initial-instance-info-replication-interval-seconds: 5
    instance-info-replication-interval-seconds: 30
    eureka-service-url-poll-interval-seconds: 10
    # Retry configuration
    registry-fetch-interval-seconds: 5
  instance:
    hostname: localhost
    prefer-ip-address: false
    instance-id: ${spring.application.name}:${server.port}
    # Lease configuration
    lease-renewal-interval-in-seconds: 30
    lease-expiration-duration-in-seconds: 90

# JWT Configuration
# SECURITY: JWT secret must be provided via environment variable in production
# Set JWT_SECRET environment variable with at least 32 characters
# For test/development only, a default secret is provided below
jwt:
  secret: ${JWT_SECRET:nebula-jwt-secret-key-change-in-production-minimum-32-characters-required}

security:
  public-routes:
    # User service endpoints (when ready)
    - /api/users/register
    - /api/users/login
    - /api/users/auth/refresh
    - /api/users/.well-known/jwks.json

    # Actuator endpoints
    - /actuator/health
    - /actuator/info

    # World-view routes - PUBLIC for testing (remove in production)
    - /api/v1/routes/**
    - /api/v1/journeys/**

    # Vehicle-service routes - PUBLIC for testing (remove in production)
    - /api/v1/vehicles/**

    # Merchandise-service routes - PUBLIC for testing (remove in production)
    - /api/v1/merchandise/**
    - /api/v1/cart/**

management:
  endpoints:
    web:
      exposure:
        include: health,info,gateway
  endpoint:
    health:
      show-details: always
    gateway:
      enabled: true

logging:
  level:
    root: INFO
    pse.nebula.gateway: DEBUG
    org.springframework.cloud.gateway: DEBUG
    org.springframework.cloud.loadbalancer: DEBUG
    # Suppress Eureka warnings when service is unavailable (non-critical)
    com.netflix.discovery: WARN
    com.netflix.eureka: WARN
    c.n.discovery.InstanceInfoReplicator: WARN
    # Suppress Eureka shutdown de-registration errors (non-critical)
    c.n.d.s.t.d.RetryableEurekaHttpClient: ERROR
